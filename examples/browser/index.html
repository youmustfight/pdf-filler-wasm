<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Form Filler - Browser Example</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: #0066cc;
      background: #f0f7ff;
    }
    .field-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .field-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .field-item:last-child { border-bottom: none; }
    .field-name { font-weight: 600; color: #333; }
    .field-type { font-size: 12px; color: #666; }
    .field-input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { background: #0055aa; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #preview {
      max-width: 100%;
      border: 1px solid #ddd;
    }
    .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .status.loading { background: #fff3cd; color: #856404; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>PDF Form Filler</h1>

  <div id="status" class="status loading">Loading WASM module...</div>

  <div class="container">
    <div class="panel">
      <h2>1. Load PDF</h2>
      <div class="drop-zone" id="dropZone">
        <p>Drop a PDF file here or click to select</p>
        <input type="file" id="fileInput" accept=".pdf" hidden>
      </div>

      <h2>2. Edit Fields</h2>
      <div class="field-list" id="fieldList">
        <p>Load a PDF to see form fields</p>
      </div>

      <h2>3. Save</h2>
      <button id="saveBtn" disabled>Download Filled PDF</button>
    </div>

    <div class="panel">
      <h2>Preview</h2>
      <canvas id="preview"></canvas>
    </div>
  </div>

  <script type="module">
    import { PdfForm, initPdfFiller } from './index.mjs';

    let currentForm = null;

    const statusEl = document.getElementById('status');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fieldList = document.getElementById('fieldList');
    const saveBtn = document.getElementById('saveBtn');
    const preview = document.getElementById('preview');

    function setStatus(message, type = 'loading') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    // Initialize WASM
    try {
      await initPdfFiller();
      setStatus('Ready! Drop a PDF file to begin.', 'success');
    } catch (err) {
      setStatus(`Failed to load WASM: ${err.message}`, 'error');
    }

    // File drop handling
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) await loadFile(file);
    });
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) await loadFile(file);
    });

    async function loadFile(file) {
      setStatus('Loading PDF...', 'loading');
      try {
        const buffer = await file.arrayBuffer();
        currentForm = await PdfForm.fromArrayBuffer(buffer);

        setStatus(`Loaded: ${currentForm.pageCount} pages`, 'success');
        renderFields();
        renderPreview();
        saveBtn.disabled = false;
      } catch (err) {
        setStatus(`Error: ${err.message}`, 'error');
      }
    }

    // Helper to escape HTML attributes
    function escapeAttr(str) {
      return String(str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function renderFields() {
      const fields = currentForm.getFields();
      if (fields.length === 0) {
        fieldList.innerHTML = '<p>No fillable fields found</p>';
        return;
      }

      // Filter out button fields (push buttons like links) - they're not editable
      const editableFields = fields.filter(f => f.type !== 'button');

      fieldList.innerHTML = editableFields.map((field, i) => {
        // Use fullName for lookups (fully qualified name)
        const fieldId = escapeAttr(field.fullName || field.name);
        const displayName = field.fullName || field.name;
        const fieldValue = escapeAttr(field.value || '');

        return `
          <div class="field-item">
            <div class="field-name">${displayName}</div>
            <div class="field-type">${field.type}${field.required ? ' (required)' : ''}</div>
            ${field.type === 'checkbox'
              ? `<input type="checkbox" class="field-input" data-name="${fieldId}" ${field.isChecked ? 'checked' : ''}>`
              : field.type === 'choice'
              ? `<select class="field-input" data-name="${fieldId}">
                  ${field.options.map(opt => `<option ${opt === field.value ? 'selected' : ''}>${escapeAttr(opt)}</option>`).join('')}
                </select>`
              : `<input type="text" class="field-input" data-name="${fieldId}" value="${fieldValue}">`
            }
          </div>
        `;
      }).join('');
    }

    function renderPreview() {
      try {
        const png = currentForm.renderPage(0, 96);
        const blob = new Blob([png], { type: 'image/png' });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
          const ctx = preview.getContext('2d');
          preview.width = img.width;
          preview.height = img.height;
          ctx.drawImage(img, 0, 0);
          URL.revokeObjectURL(url);
        };
        img.src = url;
      } catch (err) {
        console.warn('Preview failed:', err);
      }
    }

    saveBtn.addEventListener('click', () => {
      // Collect field values - wrap each in try-catch to handle errors
      const inputs = fieldList.querySelectorAll('.field-input');
      let successCount = 0;
      let errorCount = 0;

      for (const input of inputs) {
        const name = input.dataset.name;
        try {
          if (input.type === 'checkbox') {
            currentForm.setCheckbox(name, input.checked);
            successCount++;
          } else if (input.value) {
            // Only set non-empty text values
            currentForm.setField(name, input.value);
            successCount++;
          }
        } catch (err) {
          console.warn(`Failed to set field "${name}":`, err.message);
          errorCount++;
        }
      }

      console.log(`Set ${successCount} fields, ${errorCount} errors`);

      // Download
      let data;
      try {
        data = currentForm.saveAsUint8Array();
      } catch (err) {
        setStatus(`Save failed: ${err.message}`, 'error');
        return;
      }
      const blob = new Blob([data], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'filled-form.pdf';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
